# k8s/services/gateway-deployment.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
        - name: api-gateway-container
          # This tag will be auto-updated by your deploy pipeline
          image: ghcr.io/techtorque-2025/api_gateway:dev-b43efd6
          ports:
            - containerPort: 8080 # The port your Go app listens on
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "300m"
          env:
            # --- We will add the JWT_SECRET here later ---
            # - name: "JWT_SECRET" 
            #   valueFrom:
            #     secretKeyRef:
            #       name: jwt-secret
            #       key: JWT_SECRET

            # These environment variables will override config.yaml
            # This tells your Go app to use the K8s service names
            # CRITICAL: Always specify the port for reliable service discovery
            - name: "AUTH_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: AUTH_SERVICE_URL
            - name: "VEHICLES_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: VEHICLES_SERVICE_URL
            - name: "APPOINTMENTS_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: APPOINTMENTS_SERVICE_URL
            - name: "PROJECT_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: PROJECT_SERVICE_URL
            - name: "TIME_LOGS_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: TIME_LOGS_SERVICE_URL
            - name: "PAYMENT_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: PAYMENT_SERVICE_URL
            - name: "ADMIN_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: ADMIN_SERVICE_URL
            - name: "NOTIFICATIONS_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: NOTIFICATIONS_SERVICE_URL
            - name: "AGENT_BOT_SERVICE_URL"
              valueFrom:
                configMapKeyRef:
                  name: gateway-config
                  key: AGENT_BOT_SERVICE_URL
---
# This is the "Front Door" - it exposes your gateway to the internet
apiVersion: v1
kind: Service
metadata:
  name: api-gateway-service
spec:
  # This tells K3s to grab port 80 on your VM
  type: ClusterIP
  selector:
    app: api-gateway # Connects to your gateway pods
  ports:
    - name: http
      port: 80 # Internal port
      targetPort: 8080 # The port your Go container listens on
